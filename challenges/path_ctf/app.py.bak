from flask import Flask, request, send_file, abort

import os
from werkzeug.middleware.dispatcher import DispatcherMiddleware
from werkzeug.serving import WSGIRequestHandler

# SCRIPT_NAME í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¯¸ë“¤ì›¨ì–´
class ScriptNameMiddleware:
    def __init__(self, app):
        self.app = app
    
    def __call__(self, environ, start_response):
        script_name = os.environ.get('SCRIPT_NAME', '')
        if script_name:
            environ['SCRIPT_NAME'] = script_name
            path_info = environ.get('PATH_INFO', '')
            if path_info.startswith(script_name):
                environ['PATH_INFO'] = path_info[len(script_name):]
        return self.app(environ, start_response)

import os

app = Flask(__name__)
# í˜„ì¬ ì•±ì˜ base path ì„¤ì •
import os
from urllib.parse import urljoin
from flask import request

def get_base_path():
    """í˜„ì¬ ì•±ì˜ base path ë°˜í™˜"""
    return "/challenges/path_ctf"

def url_for_relative(endpoint):
    """ìƒëŒ€ ê²½ë¡œ URL ìƒì„±"""
    base = get_base_path()
    if endpoint == "index" or endpoint == "/":
        return base + "/"
    elif endpoint.startswith("/"):
        return base + endpoint
    else:
        return base + "/" + endpoint

# í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ context processor ì¶”ê°€
@app.context_processor
def inject_base_path():
    return {
        'base_path': get_base_path(),
        'url_for_relative': url_for_relative
    }



# WSGI ë¯¸ë“¤ì›¨ì–´ ì ìš©
app.wsgi_app = ScriptNameMiddleware(app.wsgi_app)

# íŒŒì¼ì´ ì‹¤ì œë¡œ ì €ì¥ë˜ëŠ” ë””ë ‰í† ë¦¬
BASE_DIR = os.path.abspath("ìë£Œì‹¤/static/ì—…ë¬´/ë©”ë‰´ì–¼")

@app.route('/')
def index():
    return '''
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì‚¬ë‚´ ë¬¸ì„œ ì—´ëŒ ì‹œìŠ¤í…œ</title>
        <style>
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #f5f7fa;
                margin: 0;
                padding: 40px 20px;
                min-height: 100vh;
            }
            .container {
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.08);
                max-width: 800px;
                margin: 0 auto;
                border: 1px solid #e1e8ed;
            }
            h1 {
                color: #2c3e50;
                margin-bottom: 8px;
                font-size: 1.8em;
                font-weight: 600;
                text-align: center;
            }
            .subtitle {
                color: #7f8c8d;
                margin-bottom: 25px;
                font-size: 1em;
                text-align: center;
            }
            .search-form {
                margin: 25px 0;
                text-align: center;
                padding: 20px;
                background: #fafbfc;
                border-radius: 6px;
                border: 1px solid #e1e8ed;
            }
            input[type="text"] {
                width: 60%;
                padding: 12px 15px;
                border: 1px solid #d1d9e0;
                border-radius: 4px;
                font-size: 14px;
                margin-bottom: 15px;
            }
            input[type="text"]:focus {
                outline: none;
                border-color: #4a90e2;
                box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
            }
            input[type="submit"] {
                background: #4a90e2;
                color: white;
                border: none;
                padding: 12px 25px;
                border-radius: 4px;
                font-size: 14px;
                cursor: pointer;
                font-weight: 500;
            }
            input[type="submit"]:hover {
                background: #357abd;
            }
            .info-section {
                background: white;
                border: 1px solid #e1e8ed;
                border-radius: 6px;
                padding: 20px;
                margin: 20px 0;
            }
            .info-title {
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 15px;
                font-size: 1.1em;
                border-bottom: 1px solid #ecf0f1;
                padding-bottom: 8px;
            }
            .file-list {
                color: #34495e;
                font-size: 0.9em;
                line-height: 1.6;
            }
            .chat-message {
                background: #f8f9fa;
                border-radius: 6px;
                padding: 15px;
                margin: 10px 0;
            }
            .message {
                margin: 12px 0;
                padding: 10px 15px;
                background: white;
                border-radius: 4px;
                border-left: 3px solid #4a90e2;
                font-size: 0.9em;
            }
            .user {
                font-weight: 600;
                color: #2c3e50;
            }
            .time {
                font-size: 0.8em;
                color: #7f8c8d;
                float: right;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ¢ ì‚¬ë‚´ ë¬¸ì„œ ì—´ëŒ ì‹œìŠ¤í…œ</h1>
            <p class="subtitle">íŒŒì¼ëª…ì„ ì…ë ¥í•´ ì¡°íšŒí•˜ì„¸ìš”</p>
            
            <div class="search-form">
                <form action="{{ base_path }}/files" method="get">
                    <input type="text" name="name" placeholder="íŒŒì¼ëª… ì…ë ¥ (ì˜ˆ: ê³µì§€ì‚¬í•­.txt)" required>
                    <br>
                    <input type="submit" value="ğŸ“ íŒŒì¼ ì¡°íšŒ">
                </form>
            </div>
            
            <div class="info-section">
                <div class="info-title">ğŸ“‹ ì‹œìŠ¤í…œ ì•ˆë‚´</div>
                <div class="file-list">
                    â€¢ ì •í™•í•œ íŒŒì¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”<br>
                    â€¢ ì§€ì› í˜•ì‹: .txt, .pdf, .doc ë“±<br>
                    â€¢ ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ì¤‘ìš” ë¬¸ì„œë“¤ì´ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤
                </div>
            </div>
            
            <div class="info-section">
                <div class="info-title">ğŸ’¬ ì‚¬ë‚´ ì±„íŒ…ë°© #ë¬¸ì„œê´€ë¦¬íŒ€</div>
                <div class="chat-message">
                    <div class="message">
                        <span class="user">ê°•ì„œìœ¤ ë¶€ì¥</span>
                        <span class="time">ì˜¤í›„ 2:30</span><br>
                        ì¤‘ìš”í•œ ê±´ ì˜¤ë˜ëœ ê¸°ë¡ì´ë‹ˆê¹Œ, ëŠ˜ ìœ„ì— ì˜ ìˆ¨ê²¨ë‘¬ì•¼ í•´.
                    </div>
                    <div class="message">
                        <span class="user">ì¥ìœ ë‹ˆ ì£¼ì„</span>
                        <span class="time">ì˜¤í›„ 3:15</span><br>
                        ê·¸ê±° ë‹¤ì‹œ ì°¾ìœ¼ë ¤ë©´ ëª‡ ë‹¨ê³„ë‚˜ ì˜¬ë¼ê°€ì•¼ í•˜ë˜ë°ìš”...ã… ã… 
                    </div>
                    <div class="message">
                        <span class="user">ìœ ì˜ˆì§€ ì¸í„´</span>
                        <span class="time">ì˜¤í›„ 3:18</span><br>
                        ê·¸ê±° íŒŒì¼ ê²½ë¡œê°€ ë„ˆë¬´ ë³µì¡í•´ì„œ ë§¤ë²ˆ í—·ê°ˆë ¤ìš” ğŸ˜… ìƒìœ„ í´ë”ë¥¼ ê³„ì† ì°¾ì•„ ì˜¬ë¼ê°€ì•¼ í•˜ëŠ” ê±´ê°€ìš”?
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
    '''

@app.route('/files')
def read_file():
    filename = request.args.get("name", "")
    filepath = os.path.abspath(os.path.join(BASE_DIR, filename))

    try:
        return send_file(filepath)
    except FileNotFoundError:
        return f'''
        <html>
        <head>
            <style>
                body {{ font-family: Arial; padding: 50px; background: #f5f5f5; }}
                .error {{ background: white; padding: 30px; border-radius: 10px; 
                         box-shadow: 0 5px 15px rgba(0,0,0,0.1); }}
            </style>
        </head>
        <body>
            <div class="error">
                <h2>âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                <p>ê²½ë¡œ: {filepath}</p>
                <a href="{{ base_path }}/">â† ëŒì•„ê°€ê¸°</a>
            </div>
        </body>
        </html>
        '''
    except Exception as e:
        return f"ì˜ˆì™¸ ë°œìƒ: {str(e)}"


if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5000, debug=False)